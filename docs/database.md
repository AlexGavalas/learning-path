# Database design

## Notes table

Here all the notes content is stored. Each markdown document is striped of some markdown syntax (eg. `---`) before each line is stored as an entry.

### Table definition

```sql
CREATE TABLE notes (
    id BIGINT GENERATED BY DEFAULT AS IDENTITY NOT NULL,
    title TEXT NOT NULL,
    line TEXT NOT NULL,
    created TIMESTAMP WITH TIME ZONE NOT NULL,
    updated TIMESTAMP WITH TIME ZONE NOT NULL,
    filename TEXT NOT NULL
);
```

`created` and `updated` refer to the document's fields.  
`filename` is stripped from the extension.

### `search_notes` function

```sql
CREATE OR REPLACE FUNCTION search_notes (q varchar) RETURNS table (title text, line text) AS $$
  BEGIN
    RETURN QUERY
      SELECT
        nc.title,
        nc.line
      FROM notes AS nc
      WHERE
        -- Convert the line to a tsvector and match it
        -- against the query (which is converted to a tsquery)
        to_tsvector(nc.line) @@ websearch_to_tsquery(q)
        OR
        -- Run similarity from the extension `pg_trgm`
        similarity (nc.line, q) > 0.5
        OR
        -- Run a regex match as a final try to match
        nc.line ilike '%' || q || '%'
      GROUP BY nc.title, nc.line;
  END;
$$ LANGUAGE plpgsql;
```

### `get_notes_meta` function

Helper function to get all distinct note files.
This is used to update the edge config data from the database.

```sql
CREATE OR REPLACE FUNCTION get_notes_meta () RETURNS table (
  title text,
  updated timestamptz,
  filename text,
  created timestamptz
) AS $$
  BEGIN
    RETURN QUERY
      SELECT
        DISTINCT ON (nc.title, nc.updated) nc.title,
        nc.updated,
        nc.filename,
        nc.created
      FROM
        notes AS nc
      ORDER BY
        nc.updated DESC, nc.title ASC;
  END;
$$ LANGUAGE plpgsql;
```

## Lesson summaries table

Here the lesson summaries frontmatter data is stored.

```sql
CREATE TABLE lesson_summaries_meta (
    id BIGINT GENERATED BY DEFAULT AS IDENTITY NOT NULL,
    created_at TIMESTAMP WITH TIME ZONE NOT NULL DEFAULT NOW(),
    filename TEXT NOT NULL,
    updated TEXT NOT NULL,
    title TEXT NOT NULL,
    created TEXT NOT NULL
);
```

`created` and `updated` refer to the document's fields.  
`filename` is stripped from the extension.
